<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{TITLE}}</title>

    <!-- 引入 Markdown 解析库 -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- 引入 KaTeX 用于渲染 LaTeX 公式 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', 'Songti SC', 'SimSun', serif;
            line-height: 1.9;
            color: #2c2c2c;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px 0;
        }

        .container {
            max-width: 720px;
            margin: 0 auto;
            background: #fafafa;
            border-radius: 4px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .header {
            background: #3a3a3a;
            color: #e8e8e8;
            padding: 30px 40px;
            text-align: center;
            border-bottom: 3px solid #5a5a5a;
        }

        .header h1 {
            font-size: 1.8em;
            font-weight: 600;
            margin-bottom: 8px;
            letter-spacing: 1px;
        }

        .header .subtitle {
            font-size: 0.95em;
            opacity: 0.85;
            font-weight: 300;
        }

        .nav-bar {
            position: sticky;
            top: 0;
            background: #f5f5f5;
            border-bottom: 1px solid #e0e0e0;
            padding: 12px 40px;
            z-index: 999;
        }

        .nav-items {
            display: flex;
            gap: 6px;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .nav-items::-webkit-scrollbar {
            display: none;
        }

        .nav-item {
            padding: 6px 14px;
            background: #fff;
            border: 1px solid #d0d0d0;
            border-radius: 3px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.25s ease;
            font-size: 0.85em;
            font-weight: 400;
            color: #4a4a4a;
        }

        .nav-item:hover {
            border-color: #666;
            background: #f8f8f8;
        }

        .nav-item.active {
            background: #3a3a3a;
            color: #fff;
            border-color: #3a3a3a;
        }

        .content {
            padding: 50px 50px 30px 50px;
        }

        .story {
            font-size: 1.15em;
            min-height: 300px;
            position: relative;
            text-align: justify;
        }

        .story p {
            margin-bottom: 1.5em;
            text-indent: 2em;
            line-height: 1.9;
        }

        .story h1, .story h2, .story h3 {
            margin-top: 2em;
            margin-bottom: 1em;
            color: #2a2a2a;
            text-align: left;
            text-indent: 0;
        }

        .story h1 {
            font-size: 1.7em;
            font-weight: 600;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 0.4em;
            margin-top: 1.5em;
        }

        .story h2 {
            font-size: 1.45em;
            font-weight: 500;
        }

        .story h3 {
            font-size: 1.25em;
            font-weight: 400;
        }

        .story code {
            background: #f0f0f0;
            padding: 2px 5px;
            border-radius: 2px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
            color: #c0392b;
            border: 1px solid #e0e0e0;
        }

        .story pre {
            background: #f8f8f8;
            padding: 18px 20px;
            border-radius: 4px;
            border-left: 3px solid #ccc;
            overflow-x: auto;
            margin: 1.5em 0;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.6;
            color: #333;
        }

        .story pre code {
            background: transparent;
            padding: 0;
            color: #333;
            border: none;
        }

        .story blockquote {
            border-left: 4px solid #888;
            padding-left: 20px;
            margin: 1.5em 0;
            padding-top: 0.5em;
            padding-bottom: 0.5em;
            color: #666;
            font-style: italic;
            background: #f5f5f5;
            padding-top: 10px;
            padding-bottom: 10px;
            padding-right: 15px;
        }

        .story ul, .story ol {
            padding-left: 2.5em;
            margin: 1.5em 0;
        }

        .story li {
            margin-bottom: 0.8em;
            line-height: 1.8;
        }

        .story strong {
            color: #1a1a1a;
            font-weight: 600;
            border-bottom: 1px solid #ddd;
            padding-bottom: 1px;
        }

        .cursor {
            display: inline-block;
            width: 2px;
            height: 1.1em;
            background: #888;
            animation: blink 1s infinite;
            vertical-align: text-bottom;
            margin-left: 2px;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        .options {
            margin-top: 40px;
            padding: 25px 30px;
            background: #f5f5f5;
            border-top: 2px solid #e0e0e0;
            border-radius: 0;
            opacity: 0;
            transform: translateY(15px);
            transition: all 0.4s ease;
        }

        .options.show {
            opacity: 1;
            transform: translateY(0);
        }

        .options h3 {
            margin-bottom: 20px;
            color: #3a3a3a;
            font-size: 1em;
            font-weight: 500;
            text-align: center;
            letter-spacing: 0.5px;
        }

        .options-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .option-btn {
            padding: 18px 25px;
            background: #fff;
            border: 1px solid #ccc;
            border-left: 3px solid #999;
            border-radius: 3px;
            cursor: pointer;
            text-align: left;
            transition: all 0.25s ease;
            font-size: 1em;
            line-height: 1.7;
            color: #3a3a3a;
            font-family: 'Georgia', 'Songti SC', 'SimSun', serif;
            font-style: italic;
            position: relative;
        }

        .option-btn:hover {
            border-color: #666;
            border-left-color: #3a3a3a;
            background: #fafafa;
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .option-btn:active {
            transform: translateX(3px);
        }

        @media (max-width: 600px) {
            body {
                padding: 0;
            }

            .content {
                padding: 35px 25px 25px 25px;
            }

            .header {
                padding: 25px 25px;
            }

            .header h1 {
                font-size: 1.5em;
            }

            .header .subtitle {
                font-size: 0.85em;
            }

            .nav-bar {
                padding: 10px 25px;
            }

            .story {
                font-size: 1.05em;
            }

            .options {
                padding: 20px 25px;
            }

            .option-btn {
                padding: 15px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>{{TITLE}}</h1>
            <div class="subtitle">{{SUBTITLE}}</div>
        </div>

        <div class="nav-bar" id="navBar" style="display: none;">
            <div class="nav-items" id="navItems">
                <!-- 章节导航按钮将由 JavaScript 动态生成 -->
            </div>
        </div>

        <div class="content">
            <div class="story" id="story">
                <!-- 故事内容将由 JavaScript 动态生成 -->
                <span class="cursor" id="cursor"></span>
            </div>
            <div class="options" id="options">
                <h3>你会怎么做？</h3>
                <div class="options-grid" id="optionsGrid">
                    <!-- 选项将由 JavaScript 动态生成 -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // 剧情数据
        const plotData = {{PLOT_DATA}};

        // 节点查找
        const nodes = {};
        plotData.nodes.forEach(node => {
            nodes[node.id] = node;
        });

        // 章节信息
        const chapters = {{CHAPTERS}};

        // 当前状态
        let currentNodeId = 'start';
        let currentChapter = 1;
        let isTyping = false;
        let isScrolling = false;
        let currentText = '';
        let currentTypingIndex = 0;
        let typingTimeout = null;
        let scrollInterval = null;

        // 获取起始节点 ID
        if (plotData.nodes.length > 0) {
            currentNodeId = plotData.nodes[0].id;
        }

        // 页面加载完成后开始
        window.onload = function() {
            initNavBar();
            goToNode(currentNodeId, false);
        };

        // 初始化导航栏
        function initNavBar() {
            const navBar = document.getElementById('navBar');
            const navItems = document.getElementById('navItems');
            if (!navBar || !navItems) return;

            navItems.innerHTML = '';

            chapters.forEach(chapter => {
                const navItem = document.createElement('div');
                navItem.className = 'nav-item';
                navItem.textContent = chapter.title;
                navItem.dataset.chapterNum = chapter.num;
                navItem.onclick = () => switchToChapter(chapter.num);
                navItems.appendChild(navItem);
            });

            updateActiveNav();

            // 如果有多个章节，显示导航栏
            if (chapters.length > 1) {
                navBar.style.display = 'block';
            }
        }

        // 更新导航栏高亮
        function updateActiveNav() {
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                const chapterNum = parseInt(item.dataset.chapterNum);
                if (chapterNum === currentChapter) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }

        // 切换章节
        function switchToChapter(chapterNum) {
            console.log('切换到章节:', chapterNum);
            const chapter = chapters.find(c => c.num === chapterNum);
            if (!chapter || !chapter.startNodeId) {
                console.error('章节或起点节点不存在:', chapterNum);
                return;
            }

            console.log('找到章节:', chapter);
            currentChapter = chapterNum;

            // 停止当前输出
            stopAutoScroll();
            if (typingTimeout) {
                clearTimeout(typingTimeout);
                typingTimeout = null;
            }

            // 清空当前内容
            const storyDiv = document.getElementById('story');
            const optionsDiv = document.getElementById('options');
            storyDiv.innerHTML = '';
            optionsDiv.innerHTML = '';
            optionsDiv.classList.remove('show');

            // 重新添加光标
            const cursor = document.createElement('span');
            cursor.className = 'cursor';
            cursor.id = 'cursor';
            storyDiv.appendChild(cursor);

            // 从新章节起点开始
            currentNodeId = chapter.startNodeId;
            console.log('跳转到节点:', currentNodeId);
            goToNode(currentNodeId, false);
        }

        // 跳转到指定节点
        function goToNode(nodeId, fromChoice = false) {
            const node = nodes[nodeId];
            if (!node) {
                console.error('节点不存在:', nodeId);
                return;
            }

            // 更新当前章节
            if (node.chapter) {
                currentChapter = node.chapter;
                updateActiveNav();
            }

            // 显示节点内容
            typeWriter(node.content, fromChoice, () => {
                if (node.isEnding) {
                    stopAutoScroll();
                    
                    // 如果当前章节不是最后一章，显示"下一章"选项
                    if (node.options && node.options.length > 0) {
                        // 使用节点中定义的选项
                        showOptions(node.options);
                    } else if (node.chapter && node.chapter < chapters.length) {
                        // 如果没有定义选项，但还有下一章，自动添加"下一章"选项
                        const nextChapter = chapters.find(c => c.num === node.chapter + 1);
                        if (nextChapter && nextChapter.startNodeId) {
                            showOptions([
                                {
                                    text: `继续阅读${nextChapter.title}`,
                                    nextNodeId: nextChapter.startNodeId
                                }
                            ]);
                        }
                    }
                } else if (node.options && node.options.length > 0) {
                    showOptions(node.options);
                }
            });
        }

        // 打字机效果
        function typeWriter(text, fromChoice, callback) {
            const cursor = document.getElementById('cursor');
            if (!cursor) return;

            isTyping = true;
            startAutoScroll();

            const lines = text.split('\n');
            let lineIndex = 0;

            function typeLine() {
                if (lineIndex >= lines.length) {
                    isTyping = false;
                    if (callback) callback();
                    return;
                }

                const line = lines[lineIndex];
                lineIndex++;

                // 解析 Markdown
                const markdown = marked.parse(line);

                // 输出整行
                const outputDiv = document.createElement('div');
                outputDiv.innerHTML = markdown;
                outputDiv.style.marginBottom = '0.5em';

                // 为段落添加小说阅读样式
                const paragraphs = outputDiv.querySelectorAll('p');
                paragraphs.forEach(p => {
                    p.style.textIndent = '2em';
                    p.style.marginBottom = '1.5em';
                    p.style.lineHeight = '1.9';
                });

                cursor.insertAdjacentElement('beforebegin', outputDiv);

                // 渲染 LaTeX 公式
                renderMathInElement(outputDiv, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false}
                    ]
                });

                // 继续下一行
                typingTimeout = setTimeout(typeLine, 50);
            }

            typeLine();
        }

        // 滚动到底部函数
        function scrollToBottom() {
            window.scrollTo({
                top: document.body.scrollHeight,
                behavior: 'smooth'
            });
        }

        // 开始自动滚动
        function startAutoScroll() {
            isScrolling = true;
            if (scrollInterval) clearInterval(scrollInterval);

            scrollInterval = setInterval(() => {
                if (isScrolling) {
                    scrollToBottom();
                }
            }, 200);
        }

        // 停止自动滚动
        function stopAutoScroll() {
            isScrolling = false;
            if (scrollInterval) {
                clearInterval(scrollInterval);
                scrollInterval = null;
            }
        }

        // 显示选项
        function showOptions(options) {
            const optionsDiv = document.getElementById('options');
            const optionsGrid = document.getElementById('optionsGrid');

            if (!optionsDiv || !optionsGrid) return;

            stopAutoScroll();
            optionsGrid.innerHTML = '';

            options.forEach(option => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.textContent = option.text;
                btn.onclick = () => selectOption(option, btn);
                optionsGrid.appendChild(btn);
            });

            optionsDiv.classList.add('show');

            // 显示选项后，滚动到底部
            setTimeout(() => {
                scrollToBottom();
            }, 100);
        }

        // 选择选项
        function selectOption(option, btn) {
            const optionsDiv = document.getElementById('options');
            if (!optionsDiv) return;

            optionsDiv.classList.remove('show');

            // 将选项文本拼接到故事中
            const cursor = document.getElementById('cursor');
            const choiceParagraph = document.createElement('p');
            choiceParagraph.style.color = '#2c2c2c';
            choiceParagraph.style.lineHeight = '1.9';
            choiceParagraph.style.marginBottom = '1.5em';
            choiceParagraph.style.textIndent = '0';
            choiceParagraph.style.fontStyle = 'italic';
            choiceParagraph.textContent = option.text;
            cursor.insertAdjacentElement('beforebegin', choiceParagraph);

            // 跳转到下一个节点
            if (option.nextNodeId) {
                goToNode(option.nextNodeId, true);
            }
        }
    </script>
</body>
</html>
