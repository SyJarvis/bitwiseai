# 分章节生成指南

## 概述

为了避免单次生成过多节点导致超出 LLM 上下文限制，需要将大型互动小说拆分成多个独立章节。

---

## 为什么需要分章节

### LLM 上下文限制

- **Token 限制**：大多数 LLM 的上下文窗口有限（如 4K、8K、32K token）
- **节点占用**：每个节点平均占用 150-300 token（content + options + metadata）
- **安全边界**：建议单次生成不超过 5000 token（约 15-30 个节点）

### 实际影响

| 节点数量 | 预估 Token | 风险等级 |
|---------|----------|---------|
| 1-10 | 500-2000 | ✅ 安全 |
| 10-20 | 2000-5000 | ✅ 推荐 |
| 20-30 | 5000-8000 | ⚠️ 注意 |
| 30-50 | 8000-15000 | ❌ 高风险 |
| 50+ | 15000+ | ❌ 极可能失败 |

---

## 分章节设计原则

### 1. 章节独立性

每个章节应该是完整的独立单元：

```json
{
  "nodes": [
    {
      "id": "chapter1_start",
      "content": "# 第一章：变量是什么？\n\n这是第一章节的开始...",
      "options": [...]
    },
    // ... 中间节点
    {
      "id": "chapter1_end",
      "content": "你学会了变量的基础知识。\n\n下一步你想：",
      "options": [
        {
          "text": "继续学习数据类型",
          "nextNodeId": "chapter2_start"
        },
        {
          "text": "结束今天的学习",
          "nextNodeId": "final_end"
        }
      ]
    }
  ],
  "metadata": {
    "title": "第一章：变量是什么？",
    "theme": "python-basics",
    "chapter": 1,
    "totalChapters": 5
  }
}
```

**要点**：
- ✅ 每章有独立的起点和终点
- ✅ 章节内 DAG 结构完整
- ✅ 终点提供"下一章"或"结束"选项
- ❌ 章节之间不要有依赖关系

### 2. 节点命名规范

使用清晰的章节前缀：

```
✅ 推荐：chapter1_start, chapter1_node2, chapter1_end
✅ 推荐：c1_n1, c1_n2, c1_end

❌ 不推荐：node1, node2, node3（无法区分章节）
❌ 不推荐：chapter1_section1_scene1_node1（太长）
```

### 3. 章节聚焦

每章聚焦 1-2 个核心知识点：

| 章节 | 核心知识点 | 节点数 |
|------|----------|--------|
| 第一章 | 变量定义 | 10-15 |
| 第二章 | 数据类型 | 10-15 |
| 第三章 | 赋值运算 | 10-15 |
| 第四章 | 字符串操作 | 15-20 |
| 第五章 | 总结练习 | 8-10 |

---

## 分章节生成流程

### 步骤 1：整体规划

首先规划整体故事结构：

```
学习主题：Python 基础

知识点分解：
1. 变量是什么？
2. 数据类型
3. 赋值和修改
4. 字符串基础
5. 总结和练习

章节划分：
- 第一章：变量是什么？（10-12 个节点）
- 第二章：数据类型（12-15 个节点）
- 第三章：赋值和修改（10-12 个节点）
- 第四章：字符串基础（12-15 个节点）
- 第五章：总结和练习（8-10 个节点）

总计：52-64 个节点
```

### 步骤 2：逐章生成

为每个章节独立生成剧情数据：

```bash
# 生成第一章
# 提示智能体：生成关于"变量是什么"的互动小说章节，包含 10-12 个节点
python3 scripts/generate_html.py chapter1.json chapter1.html

# 生成第二章
# 提示智能体：生成关于"数据类型"的互动小说章节，包含 12-15 个节点
python3 scripts/generate_html.py chapter2.json chapter2.html

# ... 继续生成其他章节
```

### 步骤 3：章节衔接设计

在每个章节的结束节点添加导航选项：

```json
{
  "id": "chapter1_end",
  "content": "你已经掌握了变量的基本概念。\n\n如果你准备好了，我们可以继续学习数据类型。",
  "isEnding": true
}
```

**重要说明**：
- 结束节点必须设置 `"isEnding": true`
- 当章节完成时，系统会自动显示章节导航
- 章节导航包含所有章节的按钮，用户可以自由跳转
- 当前章节的按钮会显示"（当前）"且不可点击

---

## 章节导航功能

### 自动章节导航

每个章节的 HTML 文件会自动包含章节导航功能。当章节完成时，会显示：

```
📚 章节导航
[第一章] [第二章] [第三章]
```

- 当前章节会显示"（当前）"标签
- 其他章节可以点击跳转
- 如果只有一个章节，不显示章节导航

### Metadata 配置

在章节的 `metadata` 中配置章节信息：

```json
{
  "metadata": {
    "title": "第一章：变量是什么？",
    "theme": "python-basics",
    "chapter": 1,
    "totalChapters": 3
  }
}
```

**字段说明**：
- `title`: 章节标题
- `theme`: 整体主题（可选，用于跨章节标识）
- `chapter`: 当前章节编号（从 1 开始）
- `totalChapters`: 总章节数量

### 文件命名约定

为了方便章节导航，建议使用以下命名约定：

```
chapter1.json  →  chapter1.html
chapter2.json  →  chapter2.html
chapter3.json  →  chapter3.html
...
```

这样章节导航会自动生成对应的跳转链接。

---

## 章节间的数据传递

### 方案 1：无状态传递（推荐）

每个章节完全独立，不需要跨章节的数据：

```
优点：简单、稳定、易于维护
缺点：无法在章节间传递用户选择的影响
适用：大多数学习场景
```

### 方案 2：URL 参数传递

通过 URL 参数传递用户状态：

```javascript
// 第一章结束
window.location.href = 'chapter2.html?path=A&score=80';

// 第二章开始
const urlParams = new URLSearchParams(window.location.search);
const userPath = urlParams.get('path');
```

**注意事项**：
- 需要修改 HTML 生成脚本
- 增加复杂度
- 可能影响隐私（URL 可见）

### 方案 3：LocalStorage 存储

使用浏览器本地存储保存状态：

```javascript
// 第一章结束
localStorage.setItem('userProgress', JSON.stringify({
  chapter: 1,
  path: 'A',
  score: 80
}));

// 第二章开始
const progress = JSON.parse(localStorage.getItem('userProgress'));
```

**注意事项**：
- 需要修改 HTML 生成脚本
- 需要添加 JavaScript 代码
- 用户清除缓存会丢失进度

---

## 最佳实践

### 1. 章节大小控制

```
✅ 推荐：10-20 个节点/章节
⚠️ 可接受：20-30 个节点/章节（简单内容）
❌ 避免：超过 30 个节点/章节
```

### 2. 章节数量

```
✅ 推荐：3-7 个章节（适中）
⚠️ 可接受：8-10 个章节（内容很多）
❌ 避免：超过 10 个章节（考虑拆分为独立课程）
```

### 3. 章节标题

使用清晰的标题：

```
✅ 推荐：
- "第一章：变量是什么？"
- "第二章：数据类型"
- "第三章：实战练习"

❌ 避免：
- "第一章"
- "Part 1"
- "Lesson 1"
```

### 4. 进度提示

在每章开头显示进度：

```
# 第二章：数据类型

进度：2/5 章节

你刚刚学会了变量是什么，现在让我们继续学习...
```

---

## 完整示例

### 第一章：变量是什么？

```json
{
  "nodes": [
    {
      "id": "chapter1_start",
      "content": "# 第一章：变量是什么？\n\n进度：1/5 章节\n\n你站在魔法学院的教室里...",
      "options": [
        {"text": "认真听讲", "nextNodeId": "chapter1_02"},
        {"text": "有点走神", "nextNodeId": "chapter1_distracted"}
      ]
    },
    {
      "id": "chapter1_02",
      "content": "导师开始讲解...",
      "options": [...]
    },
    // ... 更多节点
    {
      "id": "chapter1_end",
      "content": "你已经掌握了变量的基本概念。\n\n本章知识点：\n- 变量是用来保存数据的容器\n- 变量需要起名字\n- 变量可以被赋值和修改\n\n准备好学习下一章了吗？",
      "options": [
        {"text": "继续学习：数据类型", "nextNodeId": "chapter2_start"},
        {"text": "今天就学到这里吧", "nextNodeId": "chapter1_complete"}
      ]
    },
    {
      "id": "chapter1_complete",
      "content": "# 第一章完成！\n\n恭喜你完成了第一章的学习。\n\n下次继续学习第二章：数据类型",
      "isEnding": true
    }
  ],
  "metadata": {
    "title": "第一章：变量是什么？",
    "theme": "python-basics",
    "chapter": 1,
    "totalChapters": 5
  }
}
```

### 第二章：数据类型

```json
{
  "nodes": [
    {
      "id": "chapter2_start",
      "content": "# 第二章：数据类型\n\n进度：2/5 章节\n\n你带着对变量的理解，走进了第二间教室...",
      "options": [
        {"text": "开始学习", "nextNodeId": "chapter2_02"}
      ]
    },
    // ... 更多节点
    {
      "id": "chapter2_end",
      "content": "你已经了解了 Python 的基本数据类型。\n\n下一步你想：",
      "options": [
        {"text": "继续学习：赋值和修改", "nextNodeId": "chapter3_start"},
        {"text": "结束今天的学习", "nextNodeId": "chapter2_complete"}
      ]
    }
  ],
  "metadata": {
    "title": "第二章：数据类型",
    "theme": "python-basics",
    "chapter": 2,
    "totalChapters": 5
  }
}
```

---

## 文件组织

推荐的项目文件组织：

```
project/
├── chapter1.json
├── chapter1.html
├── chapter2.json
├── chapter2.html
├── chapter3.json
├── chapter3.html
├── chapter4.json
├── chapter4.html
├── chapter5.json
└── chapter5.html
```

或使用文件夹组织：

```
python-basics-course/
├── chapter1/
│   ├── data.json
│   └── index.html
├── chapter2/
│   ├── data.json
│   └── index.html
├── chapter3/
│   ├── data.json
│   └── index.html
├── chapter4/
│   ├── data.json
│   └── index.html
└── chapter5/
    ├── data.json
    └── index.html
```

---

## 常见问题

### Q1：如何确定每章应该包含多少节点？

**A**：根据知识点复杂度和 LLM 上下文限制：
- 简单知识点：10-12 个节点
- 中等复杂度：12-15 个节点
- 复杂知识点：15-20 个节点

### Q2：章节之间可以传递数据吗？

**A**：可以，但需要额外的 JavaScript 代码。建议优先使用无状态设计。

### Q3：如果用户想跳过章节怎么办？

**A**：章节终点可以提供多个选项：
- "继续学习下一章"
- "跳到总结练习"
- "结束今天的学习"

### Q4：如何处理章节间的剧情连贯性？

**A**：每章开头简要回顾上一章的内容：
```
# 第二章：数据类型

你刚刚学会了变量是什么，现在让我们继续学习数据类型...
```

---

## 选项拼接功能

### 无缝融入设计

当用户点击选项时，选项文本会无缝融入故事内容，作为段落直接显示。

**显示效果**：

```
[故事内容...]

"这就像是给东西起名字一样？"

[后续故事继续...]
```

**设计特点**：
- 选项文本以普通段落形式显示
- 与故事内容完全一致的样式
- 无任何特殊标记或容器包裹
- 形成连贯的阅读体验，像真正的对话

### 设计建议

为了让选项无缝融入效果更好，建议：

1. **选项要像自然对话**：
   ```
   ✅ 好的："这就像是给东西起名字一样？"
   ❌ 不好："点击这里选择：这就像是给东西起名字一样？"
   ```

2. **选项要反映真实想法**：
   ```
   ✅ 好的："我还是不太明白"
   ❌ 不好："请解释得更清楚一点"
   ```

3. **避免重复内容**：
   ```
   ✅ 好的："继续学习"
   ❌ 不好："点击继续学习下一章内容"
   ```

4. **选项文本要简洁**：
   ```
   ✅ 好的："试试这个方法"
   ❌ 不好："我想试试这个方法看看效果如何"
   ```

---

## 总结

分章节生成的关键要点：

1. **控制单章大小**：每章 10-20 个节点
2. **保持章节独立**：每章有完整的 DAG 结构
3. **清晰章节标题**：使用描述性的标题
4. **提供进度提示**：让用户知道当前进度
5. **简化章节衔接**：使用章节导航自由跳转
6. **选项无缝融入**：用户选择以普通段落形式融入故事内容

通过分章节生成，可以有效避免超出 LLM 上下文限制，同时保持良好的用户体验。章节导航和选项无缝融入功能让整个互动小说更像一本可以自由翻阅的书，用户的选择自然地成为故事的一部分。
